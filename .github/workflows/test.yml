name: Integration Test
on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      issue_number:
        required: false
        type: string
        default: ""

jobs:
  test-binary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: nginx-mainline-mk-${{ inputs.version }}-amd64
          path: ./

      - name: Install Runtime Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            apache2-utils libmaxminddb0 libxml2 libxslt1.1 libgd3 \
            libpam0g libzstd1 libpcre2-8-0 openssl perl tzdata moreutils

      - name: Extract and Install
        id: install
        run: |
          # æŸ¥æ‰¾æ–‡ä»¶ï¼Œä»¥é˜²ç‰ˆæœ¬å·åŒ¹é…æœ‰ç»†å¾®å·®å¼‚ï¼ˆè™½ç„¶é€šå¸¸ä¸ä¼šï¼‰
          TAR_FILE=$(find . -name "nginx-mainline-mk-*-linux-amd64.tar.gz" | head -n 1)
          
          if [ -z "$TAR_FILE" ]; then
             echo "Error: Artifact file not found!"
             ls -R
             echo "status=failure" >> $GITHUB_OUTPUT
             exit 1
          fi

          echo "Installing $TAR_FILE..."
          if sudo tar -xzf "$TAR_FILE" -C /; then
            echo "status=success" >> $GITHUB_OUTPUT
            sudo ldconfig
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify Version info
        id: version_check
        run: |
          if OUTPUT=$(/usr/sbin/nginx -V 2>&1); then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "$OUTPUT" > nginx_info.txt
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Failed to get version info" > nginx_info.txt
          fi

      - name: Start and Verify Server Header
        id: server_header
        run: |
          sudo mkdir -p /var/log/nginx /var/cache/nginx
          sudo /usr/sbin/nginx
          sleep 2
          
          RESPONSE=$(curl -I -s http://localhost || echo "Curl failed")
          echo "$RESPONSE"
          
          if echo "$RESPONSE" | grep -q "Server: nginx-mainline-mk"; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Generate Report
        if: always()
        run: |
          # æ”¶é›†ç»“æœ
          INSTALL_STATUS="${{ steps.install.outcome == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}"
          VERSION_STATUS="${{ steps.version_check.outcome == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}"
          HEADER_STATUS="${{ steps.server_header.outcome == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}"
          
          if [ "${{ steps.install.outcome }}" == "success" ] && \
             [ "${{ steps.version_check.outcome }}" == "success" ] && \
             [ "${{ steps.server_header.outcome }}" == "success" ]; then
             STATUS="âœ… é€šè¿‡"
             EMOJI="ğŸ‰"
          else
             STATUS="âŒ å¤±è´¥"
             EMOJI="âš ï¸"
          fi
          
          # ç”Ÿæˆ markdown
          cat << EOF > test_report.md
          # $EMOJI Nginx Source æœ¬åœ°æµ‹è¯•æŠ¥å‘Š
          
          ## ğŸ“‹ ä¿¡æ¯
          | é¡¹ç›® | å€¼ |
          |:---|:---|
          | ç‰ˆæœ¬ | \`${{ inputs.version }}\` |
          | è¿è¡Œç¼–å· | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | è§¦å‘è€… | @${{ github.actor }} |
          
          **æ€»è¯„: $STATUS**
          
          ## ğŸ“Š æµ‹è¯•ç»“æœ
          | æµ‹è¯•é¡¹ | ç»“æœ |
          |:---|:---|
          | å®‰è£…ä¸è§£å‹ | $INSTALL_STATUS |
          | ç‰ˆæœ¬æ£€æŸ¥ (nginx -V) | $VERSION_STATUS |
          | Server å¤´éªŒè¯ | $HEADER_STATUS |
          
          ## ğŸ”§ è¯¦ç»†ä¿¡æ¯
          \`\`\`
          $(cat nginx_info.txt 2>/dev/null || echo "N/A")
          \`\`\`
          
          ---
          *Report generated by GitHub Actions*
          EOF

      - name: Write Job Summary
        if: always()
        run: cat test_report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: |
             test_report.md
             nginx_info.txt

      - name: Comment on Issue
        if: always() && inputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');
            const issueNumber = '${{ inputs.issue_number }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: report
            });
